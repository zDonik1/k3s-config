---
apiVersion: v1
kind: Namespace
metadata:
  name: sleep-track
  labels:
    name: sleep-track

# ==== PostgreSQL
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgresql-pvc
  namespace: sleep-track
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgresql
  namespace: sleep-track
  labels:
    app: postgresql
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgresql
  template:
    metadata:
      labels:
        app: postgresql
    spec:
      containers:
        - name: postgresql
          image: postgres:15
          ports:
            - name: postgres
              containerPort: 5432
          env:
            - name: POSTGRES_DB
              value: sleeptrack
            - name: POSTGRES_USER
              value: sleeptrack
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-secret
                  key: password
          volumeMounts:
            - name: postgresql-storage
              mountPath: /var/lib/postgresql/data
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - sleeptrack
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - sleeptrack
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: postgresql-storage
          persistentVolumeClaim:
            claimName: postgresql-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: postgresql-service
  namespace: sleep-track
  labels:
    app: postgresql
spec:
  selector:
    app: postgresql
  ports:
    - name: postgres
      port: 5432
      targetPort: postgres
      protocol: TCP

# ==== Sleep tracker
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sleep-track-server
  namespace: sleep-track
  labels:
    app: sleep-track-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sleep-track-server
  template:
    metadata:
      labels:
        app: sleep-track-server
    spec:
      containers:
        - name: sleep-track-server
          image: ghcr.io/zdonik1/sleep-track:wmf2y2i87vvwnjiwbfy5c3kd9lmx5g47
          ports:
            - name: http
              containerPort: 8001
          env:
            - name: PGHOST
              value: "postgresql-service"
            - name: PGPORT
              value: "5432"
            - name: PGSSLMODE
              value: "disable"
            - name: PGDATABASE
              value: sleeptrack
            - name: PGUSER
              value: sleeptrack
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-secret
                  key: password
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 2
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 2
            periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: sleep-track-service
  namespace: sleep-track
  labels:
    app: sleep-track-server
spec:
  selector:
    app: sleep-track-server
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: sleep-track-ingress
  namespace: sleep-track
spec:
  entryPoints:
    - websecure
  routes:
    - kind: Rule
      match: Host(`sleept.tokhirov.uz`)
      services:
        - name: sleep-track-service
          namespace: sleep-track
          port: http
  tls:
    certResolver: letsencrypt
